<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta
      name="viewport"
      content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width"
    >
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <!-- CSS bawaan qgis2web + plugin -->
    <link rel="stylesheet" href="css/leaflet.css">
    <link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
    <link rel="stylesheet" href="css/qgis2web.css">
    <link rel="stylesheet" href="css/fontawesome-all.min.css">
    <link rel="stylesheet" href="css/leaflet-search.css">
    <link rel="stylesheet" href="css/leaflet.photon.css">
    <link rel="stylesheet" href="css/leaflet-measure.css">

    <!-- Reset dasar: jangan sentuh #map di sini, biar diatur di qgis2web.css -->
    <style>
      html,
      body {
        width: 100%;
        height: 100%;
        padding: 0;
        margin: 0;
      }
    </style>

    <title>Peta Potensi Ekonomi Desa Kab. Kulon Progo</title>
  </head>

  <body>

 
 <!-- PANEL INSTRUKSI -->
<div id="instruksi-layer" style="
  display:none;
  position:absolute;
  top:78px; /* pas di bawah header biru */
  left:calc(260px + (100% - 260px)/2); /* ketengah di atas peta (map mulai 260px dari kiri) */
  transform:translateX(-50%);
  background:#f5f5f5ee;
  padding:8px 14px;
  border-radius:8px;
  box-shadow:0 2px 6px rgba(0,0,0,0.18);
  font-size:13px;
  font-family:'Inter', sans-serif;
  color:#333;
  border:1px solid #dddddd;
  z-index:9999;
  align-items:center;
  gap:8px;
">
  <span id="instruksi-text">
    Klik salah satu wilayah kecamatan atau titik di peta untuk melihat informasi.
  </span>

  <!-- tombol X -->
  <button id="instruksi-close" style="
    border:none;
    background:transparent;
    font-size:16px;
    line-height:1;
    cursor:pointer;
    color:#555;
    padding:0 2px;
  ">
    ×
  </button>
</div>


<!-- PANEL INFORMASI BESAR -->
<div id="panel-info" style="
  display:none;
  position:absolute;
  right:0;
  top:70px;
  width:260px;
  height:calc(100% - 78px); /* sisanya sampai bawah */
  background:white;
  padding:16px 18px;
  box-shadow:-2px 0 5px rgba(0,0,0,0.2);
  z-index:9999;
  overflow-y:auto;
">
  <div class="panel-info-header">
  <span class="panel-info-title">INFORMASI</span>
  <button class="panel-info-close" onclick="tutupPanel()">×</button>
</div>


  <div id="isi-panel-info" style="
    margin-top:10px;
    font-size:13px;
    font-family:'Inter',sans-serif;
    color:#333;
  "></div>
</div>

<style>
  
 /* QGIS2WEB: layout map */
#map {
  position:absolute;
  top:70px;       /* di bawah header biru */
  left:260px;     /* lebar sidebar kiri */
  right:0;
  bottom:0;
  transition:right 0.25s ease;
}

/* Panel info kebuka → map bergeser kiri */
body.panel-open #map {
  right:260px;    /* = lebar panel-info */
}

/* Instruksi posisi awal (tengah area map penuh) */
#instruksi-layer {
  transition:left 0.25s ease;
  left:calc(260px + (100% - 260px)/2);
}

/* Instruksi saat panel-info kebuka (tengah area map yang menyempit) */
body.panel-open #instruksi-layer {
  left:calc(260px + (100% - 260px - 260px)/2);
}
#instruksi-layer {
  display: none;
}


</style>



    <!-- HEADER CUSTOM (ALA DEVANTA) -->
    <div id="custom-header">
      <div class="header-left">
        <img src="images/transp.png" id="header-logo" alt="Logo">
        <div class="header-title">
          <h1>PETA POTENSI EKONOMI DESA KABUPATEN KULON PROGO</h1>
        </div>
      </div>

      <div class="header-right">
        <h2>Tahun 2025</h2>
      </div>
    </div>

    <!-- SIDEBAR KIRI -->
    <div id="sidebar">
      <div class="section-title">
    <img src="images/layerr.png">
    <span>Layer</span>
</div>
      <label>
        <input type="checkbox" id="cb_pasar">
        Pasar 
      </label>
      <br>
      <label>
        <input type="checkbox" id="cb_jalan">
        Jalan
      </label>
      <br>
      <label>
        <input type="checkbox" id="cb_kulprog">
        Aksesibilitas Terhadap Pasar
      </label>
      <br>
      <label>
        <input type="checkbox" id="cb_bekerja">
        Rasio Penduduk Bekerja 
    </label>
    <br>
    <label>
      <input type="checkbox" id="cb_umkm">
      Kepadatan Aktivitas UMKM 
    </label>
    <br>
      <div class="section-title">
    <img src="images/legenda.png">
    <span>Legenda</span>
</div>


      <!-- Legenda per-layer, muncul sesuai checkbox -->
  <div id="leg_kulprog" style="display:none; margin-bottom:8px;">

  <div class="legend-box">
      <div class="legend-title-inside">Tingkat Aksesibilitas (km)</div>

      <div class="legend-item">
        <span class="legend-color legend-veryhigh"></span>
        <span>0,86 - 1,82</span>
      </div>
      <div class="legend-item">
        <span class="legend-color legend-high"></span>
        <span>1,82 - 3,97</span>
      </div>
      <div class="legend-item">
        <span class="legend-color legend-medium"></span>
        <span>3,97 - 5,61</span>
      </div>
      <div class="legend-item">
        <span class="legend-color legend-low"></span>
        <span>5,61 - 8,017</span>
      </div>
      <div class="legend-item">
        <span class="legend-color legend-verylow"></span>
        <span>8,017 - 21,984</span>
      </div>
  </div>
</div>

<!-- LEGEND: Rasio Penduduk Bekerja -->
<div id="leg_bekerja" style="display:none; margin-bottom:8px;">
  <div class="legend-box">
    <div class="legend-title-inside">Rasio Penduduk Bekerja (%)
    </div>

    <div class="legend-item">
  <span class="legend-circle">
    <span class="circle-bkrja-1"></span>
  </span>
  <span>73,49 - 73,94</span>
</div>

<div class="legend-item">
  <span class="legend-circle">
    <span class="circle-bkrja-2"></span>
  </span>
  <span>73,94 - 74,30</span>
</div>

<div class="legend-item">
  <span class="legend-circle">
    <span class="circle-bkrja-3"></span>
  </span>
  <span>74,30 - 74,47</span>
</div>

<div class="legend-item">
  <span class="legend-circle">
    <span class="circle-bkrja-4"></span>
  </span>
  <span>74,47 - 74,73</span>
</div>

<div class="legend-item">
  <span class="legend-circle">
    <span class="circle-bkrja-5"></span>
  </span>
  <span>74,73 - 99,18</span>
</div>

  </div>
</div>

<!-- LEGEND: Rasio UMKM -->
<div id="leg_umkm" style="display:none; margin-bottom:8px;">
  <div class="legend-box">
    <div class="legend-title-inside">Kepadatan Aktivitas UMKM</div>

    <div class="umkm-legend-item">
      <span class="umkm-legend-circle">
        <span class="umkm-color umkm-c1"></span>
      </span>
      <span>0 - 0,044</span>
    </div>

    <div class="umkm-legend-item">
      <span class="umkm-legend-circle">
        <span class="umkm-color umkm-c2"></span>
      </span>
      <span>0,044 - 0,179</span>
    </div>

    <div class="umkm-legend-item">
      <span class="umkm-legend-circle">
        <span class="umkm-color umkm-c3"></span>
      </span>
      <span>0,179 - 0,305</span>
    </div>

    <div class="umkm-legend-item">
      <span class="umkm-legend-circle">
        <span class="umkm-color umkm-c4"></span>
      </span>
      <span>0,305 - 0,393</span>
    </div>

    <div class="umkm-legend-item">
      <span class="umkm-legend-circle">
        <span class="umkm-color umkm-c5"></span>
      </span>
      <span>0,393 - 0,433</span>
    </div>

  </div>
</div>

      

      <div id="leg_jalan" style="display:none; margin-bottom:8px;">

  <div class="legend-box">
    <div class="legend-title-inside"> Jalan</div>

    <div class="legend-item">
      <span style="
        display:inline-block;
        width:20px;
        height:3px;
        background:#909090;   /* abu-abu */
        margin-right:6px;
        border:1px solid #555; /* outline biar jelas */
      "></span>
      <span>Jalan Utama</span>
    </div>

  </div>

</div>

 <!--pasarrr-->
   <div id="leg_pasar" style="display:none; margin-bottom:8px;">

  <div class="legend-box">
    <div class="legend-title-inside">Pasar</div>

    <div class="legend-item">
      <span class="legend-pasar-icon">
        <img src="images/psr.png" alt="ikon pasar">
      </span>
      <span>Lokasi Pasar</span>
    </div>

  </div>
</div>

    </div>

    <!-- KANVAS PETA -->
    <div id="map"></div>

    <!-- JS LIBRARIES -->
    <script src="js/qgis2web_expressions.js"></script>
    <script src="js/leaflet.js"></script>
    <script src="js/L.Control.Layers.Tree.min.js"></script>
    <script src="js/leaflet.rotatedMarker.js"></script>
    <script src="js/leaflet.pattern.js"></script>
    <script src="js/leaflet-hash.js"></script>
    <script src="js/Autolinker.min.js"></script>
    <script src="js/rbush.min.js"></script>
    <script src="js/labelgun.min.js"></script>
    <script src="js/labels.js"></script>
    <script src="js/leaflet.photon.js"></script>
    <script src="js/leaflet-measure.js"></script>
    <script src="js/leaflet-search.js"></script>

    <!-- DATA LAYER -->
    <script src="data/kulprogkeckeckp_1.js"></script>
    <script src="data/titikkkRasio_UMKM_2.js"></script>
    <script src="data/jalanbnrjalann_3.js"></script>
    <script src="data/pasarunikpasarr_4.js"></script>

    <!-- SCRIPT PETA -->
    <script>
      var highlightLayer;

      function highlightFeature(e) {
        highlightLayer = e.target;

        if (
          e.target.feature.geometry.type === "LineString" ||
          e.target.feature.geometry.type === "MultiLineString"
        ) {
          highlightLayer.setStyle({
            color: "#ffff00",
          });
        } else {
          highlightLayer.setStyle({
            fillColor: "#ffff00",
            fillOpacity: 1,
          });
        }
        highlightLayer.openPopup();
      }

      var map = L.map("map", {
        zoomControl: false,
        maxZoom: 28,
        minZoom: 1,
      }).fitBounds([
        [-7.979572680037286, 109.8953591820834],
        [-7.618815839887425, 110.4389430181463],
      ]);

      var hash = new L.Hash(map);
      map.attributionControl.setPrefix(
        '<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a> &middot; ' +
          '<a href="https://leafletjs.com" title="A JS library for interactive maps">Leaflet</a> &middot; ' +
          '<a href="https://qgis.org">QGIS</a>'
      );

      var autolinker = new Autolinker({
        truncate: { length: 30, location: "smart" },
      });

      // remove popup's row if "visible-with-data"
      function removeEmptyRowsFromPopupContent(content, feature) {
        var tempDiv = document.createElement("div");
        tempDiv.innerHTML = content;
        var rows = tempDiv.querySelectorAll("tr");
        for (var i = 0; i < rows.length; i++) {
          var td = rows[i].querySelector("td.visible-with-data");
          var key = td ? td.id : "";
          if (
            td &&
            td.classList.contains("visible-with-data") &&
            feature.properties[key] == null
          ) {
            rows[i].parentNode.removeChild(rows[i]);
          }
        }
        return tempDiv.innerHTML;
      }

      // modify popup if contains media
      function addClassToPopupIfMedia(content, popup) {
        var tempDiv = document.createElement("div");
        tempDiv.innerHTML = content;
        var imgTd = tempDiv.querySelector("td img");
        if (imgTd) {
          var src = imgTd.getAttribute("src");
          if (/\.(jpg|jpeg|png|gif|bmp|webp|avif)$/i.test(src)) {
            popup._contentNode.classList.add("media");
            setTimeout(function () {
              popup.update();
            }, 10);
          } else if (/\.(mp3|wav|ogg|aac)$/i.test(src)) {
            var audio = document.createElement("audio");
            audio.controls = true;
            audio.src = src;
            imgTd.parentNode.replaceChild(audio, imgTd);
            popup._contentNode.classList.add("media");
            setTimeout(function () {
              popup.setContent(tempDiv.innerHTML);
              popup.update();
            }, 10);
          } else if (/\.(mp4|webm|ogg|mov)$/i.test(src)) {
            var video = document.createElement("video");
            video.controls = true;
            video.src = src;
            video.style.width = "400px";
            video.style.height = "300px";
            video.style.maxHeight = "60vh";
            video.style.maxWidth = "60vw";
            imgTd.parentNode.replaceChild(video, imgTd);
            popup._contentNode.classList.add("media");
            video.addEventListener("loadedmetadata", function () {
              popup.update();
            });
            setTimeout(function () {
              popup.setContent(tempDiv.innerHTML);
              popup.update();
            }, 10);
          } else {
            popup._contentNode.classList.remove("media");
          }
        } else {
          popup._contentNode.classList.remove("media");
        }
      }

      // ZOOM & MEASURE CONTROL
      var zoomControl = L.control
        .zoom({
          position: "topleft",
        })
        .addTo(map);

      var measureControl = new L.Control.Measure({
        position: "topleft",
        primaryLengthUnit: "meters",
        secondaryLengthUnit: "kilometers",
        primaryAreaUnit: "sqmeters",
        secondaryAreaUnit: "hectares",
      });
      measureControl.addTo(map);
      document.getElementsByClassName("leaflet-control-measure-toggle")[0]
        .innerHTML = "";
      document.getElementsByClassName("leaflet-control-measure-toggle")[0]
        .className += " fas fa-ruler";

      var bounds_group = new L.featureGroup([]);
      function setBounds() {}

      // BASEMAP
      map.createPane("pane_OSMStandard_0");
      map.getPane("pane_OSMStandard_0").style.zIndex = 400;
      var layer_OSMStandard_0 = L.tileLayer(
        "http://tile.openstreetmap.org/{z}/{x}/{y}.png",
        {
          pane: "pane_OSMStandard_0",
          opacity: 1.0,
          attribution:
            '<a href="https://www.openstreetmap.org/copyright">© OpenStreetMap contributors, CC-BY-SA</a>',
          minZoom: 1,
          maxZoom: 28,
          minNativeZoom: 0,
          maxNativeZoom: 19,
        }
      );
      map.addLayer(layer_OSMStandard_0);
      
// PANEL INFORMASI
function bukaPanel(html) {
  var panel = document.getElementById("panel-info");
  panel.style.display = "block";
  document.getElementById("isi-panel-info").innerHTML = html;

  // kasih class ke body -> map & instruksi geser
  document.body.classList.add("panel-open");
}

function tutupPanel() {
  var panel = document.getElementById("panel-info");
  panel.style.display = "none";

  // hapus class -> map & instruksi balik lagi normal
  document.body.classList.remove("panel-open");
}


// flag: apakah user sudah nutup instruksi pakai X
var instruksiDitutupManual = false;

// ====== FUNGSI BARU: atur instruksi di atas peta ======
function updateInstruksi() {
  var box  = document.getElementById("instruksi-layer");
  var text = document.getElementById("instruksi-text");

  // akses checkbox
  var cbKulprog  = document.getElementById("cb_kulprog");
  var cbBekerja  = document.getElementById("cb_bekerja");
  var cbUmkm     = document.getElementById("cb_umkm");
  var cbPasar    = document.getElementById("cb_pasar");

  // cek apakah ada layer yang menampilkan info (klik / popup)
  var adaLayerInfo =
    (cbKulprog && cbKulprog.checked)  ||
    (cbBekerja && cbBekerja.checked)  ||
    (cbUmkm && cbUmkm.checked)        ||
    (cbPasar && cbPasar.checked);

  if (!adaLayerInfo) {
    // kalau semua mati -> instruksi hilang
    box.style.display = "none";
    return;
  }

  // kalau sudah di-X, jangan paksa muncul lagi
  if (instruksiDitutupManual) return;

  // ada minimal satu checkbox ON -> tampilkan instruksi
  box.style.display = "flex";
  text.textContent =
    "Klik salah satu wilayah kecamatan atau titik di peta untuk melihat informasi.";
}
// tombol X di panel instruksi
var btnInstruksiClose = document.getElementById("instruksi-close");
btnInstruksiClose.addEventListener("click", function () {
  document.getElementById("instruksi-layer").style.display = "none";
  instruksiDitutupManual = true; // jangan muncul lagi sampai halaman di-refresh
});

      /* ========== LAYER 1: Batas Desa / Potensi Ekonomi ========== */

      function pop_kulprogkeckeckp_1(feature, layer) {
        layer.on({
          mouseout: function (e) {
            for (var i in e.target._eventParents) {
              if (
                typeof e.target._eventParents[i].resetStyle === "function"
              ) {
                e.target._eventParents[i].resetStyle(e.target);
              }
            }
            if (typeof layer.closePopup == "function") {
              layer.closePopup();
            } else {
              layer.eachLayer(function (feature) {
                feature.closePopup();
              });
            }
          },
          mouseover: highlightFeature,
        });
        var popupContent =
  '<div style="font-family: Inter, sans-serif; font-size:13px; color:#333;">\
     <table style="border-collapse:collapse;">\
       <tr>\
         <th style="text-align:left; padding-right:6px; width:95px; font-weight:600;">Kecamatan :</th>\
         <td>' +
           (feature.properties["WADMKC"] ?? "-") +
         '</td>\
       </tr>\
       <tr>\
         <th style="text-align:left; padding-right:6px; width:95px; font-weight:600;">Jarak (m) :</th>\
         <td>' +
           (feature.properties["jarak_min"] ?? "-") +
         '</td>\
       </tr>\
     </table>\
   </div>';
   
// ⬇⬇⬇ TAMBAHAN: klik kecamatan → buka panel info kanan
  layer.on("click", function () {
    const nama  = feature.properties["WADMKC"]   ?? "-";
    const jarak = feature.properties["jarak_min"] ?? "-";

   let html = `
    <p style="margin:0 0 6px 0;">
    <b>Kecamatan:</b> ${nama}
  </p>

  <p style="margin:0 0 10px 0;">
    <b>Jarak Minimum:</b> ${jarak} m
  </p>
      <p style="font-size:13px; line-height:1.45; text-align:justify; text-justify:inter-word;">
      Jarak minimum dihitung dari titik tengah kecamatan ke pasar terdekat 
      melalui jaringan jalan utama. Nilai ini merupakan estimasi awal aksesibilitas 
      dan tidak selalu mencerminkan jarak tempuh sebenarnya di lapangan.
      </p>
    `;

    bukaPanel(html);
  });
        var content = removeEmptyRowsFromPopupContent(popupContent, feature);
        layer.on("popupopen", function (e) {
          addClassToPopupIfMedia(content, e.popup);
        });
        layer.bindPopup(content, { maxHeight: 400 });
      }

      function style_kulprogkeckeckp_1_0(feature) {
        var v = feature.properties["jarak_min"];

        if (v >= 860.088 && v <= 1822.2314) {
          return {
            pane: "pane_kulprogkeckeckp_1",
            opacity: 1,
            color: "rgba(35,35,35,1.0)",
            dashArray: "",
            lineCap: "butt",
            lineJoin: "miter",
            weight: 1.0,
            fill: true,
            fillOpacity: 0.8,
            fillColor: "rgba(26,150,65,1.0)",
            interactive: true,
          };
        }
        if (v > 1822.2314 && v <= 3974.5734) {
          return {
            pane: "pane_kulprogkeckeckp_1",
            opacity: 1,
            color: "rgba(35,35,35,1.0)",
            dashArray: "",
            lineCap: "butt",
            lineJoin: "miter",
            weight: 1.0,
            fill: true,
            fillOpacity: 0.8,
            fillColor: "rgba(166,217,106,1.0)",
            interactive: true,
          };
        }
        if (v > 3974.5734 && v <= 5617.1922) {
          return {
            pane: "pane_kulprogkeckeckp_1",
            opacity: 1,
            color: "rgba(35,35,35,1.0)",
            dashArray: "",
            lineCap: "butt",
            lineJoin: "miter",
            weight: 1.0,
            fill: true,
            fillOpacity: 0.8,
            fillColor: "rgba(255,255,192,1.0)",
            interactive: true,
          };
        }
        if (v > 5617.1922 && v <= 8017.4992) {
          return {
            pane: "pane_kulprogkeckeckp_1",
            opacity: 1,
            color: "rgba(35,35,35,1.0)",
            dashArray: "",
            lineCap: "butt",
            lineJoin: "miter",
            weight: 1.0,
            fill: true,
            fillOpacity: 0.8,
            fillColor: "rgba(253,174,97,1.0)",
            interactive: true,
          };
        }
        if (v > 8017.4992 && v <= 21983.8) {
          return {
            pane: "pane_kulprogkeckeckp_1",
            opacity: 1,
            color: "rgba(35,35,35,1.0)",
            dashArray: "",
            lineCap: "butt",
            lineJoin: "miter",
            weight: 1.0,
            fill: true,
            fillOpacity: 0.8,
            fillColor: "rgba(215,25,28,1.0)",
            interactive: true,
          };
        }
      }

      map.createPane("pane_kulprogkeckeckp_1");
      map.getPane("pane_kulprogkeckeckp_1").style.zIndex = 401;
      map.getPane("pane_kulprogkeckeckp_1").style["mix-blend-mode"] =
        "normal";

      var layer_kulprogkeckeckp_1 = new L.geoJson(json_kulprogkeckeckp_1, {
        attribution: "",
        interactive: true,
        dataVar: "json_kulprogkeckeckp_1",
        layerName: "layer_kulprogkeckeckp_1",
        pane: "pane_kulprogkeckeckp_1",
        onEachFeature: pop_kulprogkeckeckp_1,
        style: style_kulprogkeckeckp_1_0,
      });
      layer_kulprogkeckeckp_1.on("click", function(e) {


  var p = e.target.feature.properties;

  var html = `
    <b>Desa: ${p.WADMKD || p.name}</b><br><br>
    <b>Jumlah Penduduk:</b> ${p.Jml_Pddk}<br>
    <b>Usia Kerja:</b> ${p.Usia_Kerja}<br>
    <b>Penduduk Bekerja:</b> ${p.Pddk_Bkrja}<br>
    <b>Rasio Penduduk Bekerja:</b> ${p.Rasio_Baru}<br><br>

    <b>UMKM Terdaftar:</b> ${p.Jml_UMKM}<br>
    <b>Kepadatan Aktivitas UMKM</b> ${p.Rasio_UMKM}<br><br>

    <b>Aksesibilitas Pasar:</b> ${p.Akses_Psr || '-'} km<br><br>

    <p style="font-size:12px; color:#666;">
      Rasio Penduduk Bekerja dihitung dari 
      jumlah penduduk usia kerja dan penduduk bekerja (Sumber: Data XYZ, 2024).
    </p>
  `;

  bukaPanel(html);
});

// Format angka ala Indonesia (1.234,56)
function formatAngkaID(value, decimals = 0) {
  if (value === null || value === undefined || value === "") return "-";

  const num = Number(value);
  if (isNaN(num)) return value;

  return new Intl.NumberFormat("id-ID", {
    minimumFractionDigits: decimals,
    maximumFractionDigits: decimals
  }).format(num);
}

// Khusus persentase (default 2 desimal)
function formatPersenID(value, decimals = 2) {
  if (value === null || value === undefined || value === "") return "-";

  const num = Number(value);
  if (isNaN(num)) return value;

  return new Intl.NumberFormat("id-ID", {
    minimumFractionDigits: decimals,
    maximumFractionDigits: decimals
  }).format(num);
}

      /* ========== LAYER 2: Titik UMKM ========== */

      function pop_titikkkRasio_UMKM_2(feature, layer) {
        layer.on({
          mouseout: function (e) {
             // cek apakah checkbox Rasio UMKM sedang aktif
      var cbUmkm = document.getElementById("cb_umkm");
      if (cbUmkm && cbUmkm.checked) {
        // kalau UMKM ON → pakai style_bekerjaUmkm (size + warna)
        e.target.setStyle(style_bekerjaUmkm(e.target.feature));
      } else {
        // kalau UMKM OFF → pakai style_bekerjaOnly (size abu-abu)
        e.target.setStyle(style_bekerjaOnly(e.target.feature));
      }

      // tutup popup seperti biasa
      if (typeof layer.closePopup == "function") {
        layer.closePopup();
      } else {
        layer.eachLayer(function (feature) {
          feature.closePopup();
        });
      }
    },
    mouseover: highlightFeature,
  });
        
      // klik titik → buka sidebar kanan
    layer.on("click", function () {
  var p = feature.properties;

  let html = `
    <p style="margin:0 0 8px 0;">
      <b>Kecamatan:</b> ${p.WADMKC ?? "-"}
    </p>

<div class="info-card">
  <div class="info-card-title">Rasio Penduduk Bekerja</div>

  <table class="info-table">
    <tr>
      <td class="label">Rasio Penduduk Bekerja</td>
      <td class="colon">:</td>
      <td class="value">
        <span class="num">${formatPersenID(p.Rasio_Baru, 2)}</span>
        <span class="unit">%</span>
      </td>
    </tr>

    <tr>
      <td class="label">Jumlah Penduduk</td>
      <td class="colon">:</td>
      <td class="value">
        <span class="num">${formatAngkaID(p.Jml_Pddk, 0)}</span>
        <span class="unit">jiwa</span>
      </td>
    </tr>

    <tr>
      <td class="label">Penduduk Usia Kerja</td>
      <td class="colon">:</td>
      <td class="value">
        <span class="num">${formatAngkaID(p.Usia_Kerja, 0)}</span>
        <span class="unit">jiwa</span>
      </td>
    </tr>

    <tr>
      <td class="label">Penduduk Bekerja</td>
      <td class="colon">:</td>
      <td class="value">
        <span class="num">${formatAngkaID(p.Pddk_Bkrja, 0)}</span>
        <span class="unit">jiwa</span>
      </td>
    </tr>
  </table>

  <hr>


  <p class="info-desc">
    Nilai rasio penduduk bekerja diperoleh dari perbandingan jumlah 
    penduduk bekerja terhadap penduduk usia kerja pada setiap kecamatan. 
    Perhitungan ini bersifat estimatif dan mungkin mengandung ketidakpastian 
    terkait akurasi data dasar.
  </p>
</div>

<div class="info-card">
  <div class="info-card-title">Kepadatan Aktivitas UMKM</div>

  <table class="info-table">
    <tr>
      <td class="label">Kepadatan</td>
      <td class="colon">:</td>
      <td class="value">${formatAngkaID(p.Rasio_UMKM, 3)}</td>
    </tr>
    <tr>
      <td class="label">Jumlah UMKM</td>
      <td class="colon">:</td>
      <td class="value">${formatAngkaID(p.Jml_UMKM, 0)}</td>
    </tr>
  </table>

  <hr>

  <p class="info-desc">
    Layer ini menunjukkan tingkat kepadatan UMKM di setiap kecamatan, 
    dihitung berdasarkan jumlah UMKM per 1.000 penduduk. Nilai yang 
    lebih tinggi mengindikasikan aktivitas ekonomi yang lebih intensif 
    dan konsentrasi usaha yang lebih padat di wilayah tersebut.
  </p>
</div>


  `;

  bukaPanel(html);
});
var popupContent =
  '<table>' +
  '<tr>' +
    '<th scope="row">Kecamatan</th>' +
    '<td>' + (feature.properties["WADMKC"] ?? "-") + '</td>' +
  '</tr>' +
  '<tr>' +
    '<th scope="row">Rasio Penduduk Bekerja</th>' +
    '<td>' + (feature.properties["Rasio_Baru"] ?? "-") + ' %</td>' +
  '</tr>' +
  '<tr>' +
    '<th scope="row">Kepadatan Aktivitas UMKM</th>' +
    '<td>' + (feature.properties["Rasio_UMKM"] ?? "-") + '</td>' +
  '</tr>' +
  '</table>';

        var content = removeEmptyRowsFromPopupContent(popupContent, feature);
        layer.on("popupopen", function (e) {
          addClassToPopupIfMedia(content, e.popup);
        });
        layer.bindPopup(content, { maxHeight: 400 });
      }

// ===== STYLE DASAR: Rasio Bekerja saja (size + abu-abu) =====
function style_bekerjaOnly(feature) {
  var b = feature.properties["Rasio_Baru"];   // rasio penduduk bekerja

  var radius;
  if (b <= 73.94) {                 // 73,49 - 73,94
    radius = 6;
  } else if (b <= 74.3) {           // 73,94 - 74,3
    radius = 8.5;
  } else if (b <= 74.47) {          // 74,3 - 74,47
    radius = 11;
  } else if (b <= 74.73) {          // 74,47 - 74,73
    radius = 13.5;
  } else {                          // 74,73 - 99,18
    radius = 16;
  }

  return {
    pane: "pane_titikkkRasio_UMKM_2",
    radius: radius,
    opacity: 1,
    color: "rgba(60,60,60,0.8)",
    weight: 1,
    fill: true,
    fillOpacity: 0.25,
    fillColor: "rgba(200,200,200,0.9)",   // abu netral
    interactive: true
  };
}

// ===== STYLE KETIKA RASIO UMKM DINYALAKAN (size sama, warna ikut UMKM) =====
function style_bekerjaUmkm(feature) {
  var b = feature.properties["Rasio_Baru"];
  var u = feature.properties["Rasio_UMKM"];

  // ukuran SAMA seperti style_bekerjaOnly (biar konsisten dengan legenda)
  var radius;
  if (b <= 73.94) {
    radius = 6;
  } else if (b <= 74.3) {
    radius = 8.5;
  } else if (b <= 74.47) {
    radius = 11;
  } else if (b <= 74.73) {
    radius = 13.5;
  } else {
    radius = 16;
  }

  // palet warna UMKM (biru kontras)
  var fillColor;
  if (u >= 0.0 && u <= 0.0442) {
    fillColor = "#f7fbff";
  } else if (u > 0.0442 && u <= 0.179) {
    fillColor = "#c6dbef";
  } else if (u > 0.179 && u <= 0.3052) {
    fillColor = "#6baed6";
  } else if (u > 0.3052 && u <= 0.393) {
    fillColor = "#2171b5";
  } else if (u > 0.393 && u <= 0.433) {
    fillColor = "#08306b";
  } else {
    fillColor = "#ffffff";
  }

  return {
    pane: "pane_titikkkRasio_UMKM_2",
    radius: radius,
    opacity: 1,
    color: "rgba(30,30,30,0.9)",
    weight: 1,
    fill: true,
    fillOpacity: 0.95,
    fillColor: fillColor,
    interactive: true
  };
}

// dipanggil pertama kali waktu layer dibuat:
function style_titikkkRasio_UMKM_2_0(feature) {
  return style_bekerjaOnly(feature);
}


      map.createPane("pane_titikkkRasio_UMKM_2");
      map.getPane("pane_titikkkRasio_UMKM_2").style.zIndex = 402;
      map.getPane("pane_titikkkRasio_UMKM_2").style["mix-blend-mode"] =
        "normal";

      var layer_titikkkRasio_UMKM_2 = new L.geoJson(json_titikkkRasio_UMKM_2, {
        attribution: "",
        interactive: true,
        dataVar: "json_titikkkRasio_UMKM_2",
        layerName: "layer_titikkkRasio_UMKM_2",
        pane: "pane_titikkkRasio_UMKM_2",
        onEachFeature: pop_titikkkRasio_UMKM_2,
        pointToLayer: function (feature, latlng) {
          return L.circleMarker(latlng, style_titikkkRasio_UMKM_2_0(feature));
        },
      });

      /* ========== LAYER 3: Jaringan Jalan ========== */

      function pop_jalanbnrjalann_3(feature, layer) {
        layer.on({
          mouseout: function (e) {
            for (var i in e.target._eventParents) {
              if (
                typeof e.target._eventParents[i].resetStyle === "function"
              ) {
                e.target._eventParents[i].resetStyle(e.target);
              }
            }
            if (typeof layer.closePopup == "function") {
              layer.closePopup();
            } else {
              layer.eachLayer(function (feature) {
                feature.closePopup();
              });
            }
          },
          mouseover: highlightFeature,
        });
        var popupContent = "<table></table>";
        var content = removeEmptyRowsFromPopupContent(popupContent, feature);
        layer.on("popupopen", function (e) {
          addClassToPopupIfMedia(content, e.popup);
        });
        layer.bindPopup(content, { maxHeight: 400 });
      }

      function style_jalanbnrjalann_3_0() {
        return {
          pane: "pane_jalanbnrjalann_3",
          opacity: 1,
          color: "rgba(145,145,145,1.0)",
          dashArray: "",
          lineCap: "square",
          lineJoin: "bevel",
          weight: 1.5,
          fillOpacity: 0,
          interactive: true,
        };
      }

      map.createPane("pane_jalanbnrjalann_3");
      map.getPane("pane_jalanbnrjalann_3").style.zIndex = 403;
      map.getPane("pane_jalanbnrjalann_3").style["mix-blend-mode"] =
        "normal";

      var layer_jalanbnrjalann_3 = new L.geoJson(json_jalanbnrjalann_3, {
        attribution: "",
        interactive: true,
        dataVar: "json_jalanbnrjalann_3",
        layerName: "layer_jalanbnrjalann_3",
        pane: "pane_jalanbnrjalann_3",
        onEachFeature: pop_jalanbnrjalann_3,
        style: style_jalanbnrjalann_3_0,
      });

      /* ========== LAYER 4: Pasar Unik ========== */

      function pop_pasarunikpasarr_4(feature, layer) {
        layer.on({
          mouseout: function (e) {
            for (var i in e.target._eventParents) {
              if (
                typeof e.target._eventParents[i].resetStyle === "function"
              ) {
                e.target._eventParents[i].resetStyle(e.target);
              }
            }
            if (typeof layer.closePopup == "function") {
              layer.closePopup();
            } else {
              layer.eachLayer(function (feature) {
                feature.closePopup();
              });
            }
          },
          mouseover: highlightFeature,
        });
        var popupContent =
          '<table>\
              <tr>\
                <td colspan="2">' +
          (feature.properties["name"] !== null
            ? autolinker.link(
                String(feature.properties["name"])
                  .replace(/'/g, "'")
                  .toLocaleString()
              )
            : "") +
          "</td>\
              </tr>\
            </table>";
        var content = removeEmptyRowsFromPopupContent(popupContent, feature);
        layer.on("popupopen", function (e) {
          addClassToPopupIfMedia(content, e.popup);
        });
        layer.bindPopup(content, { maxHeight: 400 });
      }

      function style_pasarunikpasarr_4_0() {
        return {
          pane: "pane_pasarunikpasarr_4",
          radius: 4.0,
          opacity: 1,
          color: "rgba(35,35,35,1.0)",
          dashArray: "",
          lineCap: "butt",
          lineJoin: "miter",
          weight: 1,
          fill: true,
          fillOpacity: 1,
          fillColor: "rgba(255,107,0,1.0)",
          interactive: true,
        };
      }

      map.createPane("pane_pasarunikpasarr_4");
      map.getPane("pane_pasarunikpasarr_4").style.zIndex = 404;
      map.getPane("pane_pasarunikpasarr_4").style["mix-blend-mode"] =
        "normal";

      // ===== ICON KHUSUS UNTUK PASAR =====
var pasarIcon = L.icon({
  iconUrl: 'images/psr.png',   // sesuai screenshot foldermu
  iconSize: [22, 22],             // boleh 24,24 kalau mau lebih besar
  iconAnchor: [11, 11],
  popupAnchor: [0, -11]
});


      var layer_pasarunikpasarr_4 = new L.geoJson(json_pasarunikpasarr_4, {
        attribution: "",
        interactive: true,
        dataVar: "json_pasarunikpasarr_4",
        layerName: "layer_pasarunikpasarr_4",
        pane: "pane_pasarunikpasarr_4",
        onEachFeature: pop_pasarunikpasarr_4,
        pointToLayer: function (feature, latlng) {
          return L.marker(latlng, { icon: pasarIcon });

        },
      });

      /* ========== OPSIONAL: Layer Tree (nggak dipakai, kamu pakai sidebar sendiri) ========== */
      var overlaysTree = [
        {
          label:
            '<img src="legend/pasarunikpasarr_4.png" /> pasar unik — psr',
          layer: layer_pasarunikpasarr_4,
        },
        {
          label:
            '<img src="legend/jalanbnrjalann_3.png" /> jalan bnr — jalann',
          layer: layer_jalanbnrjalann_3,
        },
        {
          label: "titikkk — Rasio_UMKM<br /><table>...</table>",
          layer: layer_titikkkRasio_UMKM_2,
        },
        {
          label: "kulprog kec — kec kp<br /><table>...</table>",
          layer: layer_kulprogkeckeckp_1,
        },
        { label: "OSM Standard", layer: layer_OSMStandard_0 },
      ];

      var lay = L.control.layers.tree(null, overlaysTree, {
        collapsed: true,
      });
      // lay.addTo(map); // kamu pakai sidebar sendiri, jadi ini dibiarkan off

      // Semua overlay dimatikan dulu (user nyalakan lewat checkbox)
      map.removeLayer(layer_kulprogkeckeckp_1);
      map.removeLayer(layer_titikkkRasio_UMKM_2);
      map.removeLayer(layer_jalanbnrjalann_3);
      map.removeLayer(layer_pasarunikpasarr_4);

      setBounds();

      // SEARCH CONTROL (cari berdasarkan WADMKC di layer batas desa)
      map.addControl(
        new L.Control.Search({
          layer: layer_kulprogkeckeckp_1,
          initial: false,
          hideMarkerOnCollapse: true,
          propertyName: "WADMKC",
        })
      );
    </script>

    <!-- SCRIPT UNTUK SIDEBAR LAYER & LEGENDA -->
<script>
// ====== CONTROL SIDEBAR LAYER ======

// Checkbox
var cbKulprog = document.getElementById("cb_kulprog");   // Aksesibilitas
var cbBekerja = document.getElementById("cb_bekerja");   // Rasio Penduduk Bekerja
var cbUmkm    = document.getElementById("cb_umkm");      // Kepadatan Aktivitas UMKM
var cbJalan   = document.getElementById("cb_jalan");     // Jalan
var cbPasar   = document.getElementById("cb_pasar");     // Pasar

// Legenda
var legKulprog = document.getElementById("leg_kulprog");
var legBekerja = document.getElementById("leg_bekerja"); 
var legUmkm    = document.getElementById("leg_umkm");
var legJalan   = document.getElementById("leg_jalan");
var legPasar   = document.getElementById("leg_pasar");

// Instruksi
var instruksiBox = document.getElementById("instruksi-layer");

// --- Kondisi awal: SEMUA overlay & legenda mati, instruksi mati ---
cbKulprog.checked = false;
cbBekerja.checked = false;
cbUmkm.checked    = false;
cbJalan.checked   = false;
cbPasar.checked   = false;

map.removeLayer(layer_kulprogkeckeckp_1);
map.removeLayer(layer_titikkkRasio_UMKM_2);
map.removeLayer(layer_jalanbnrjalann_3);
map.removeLayer(layer_pasarunikpasarr_4);

if (legKulprog) legKulprog.style.display = "none";
if (legBekerja) legBekerja.style.display = "none";
if (legUmkm)    legUmkm.style.display    = "none";
if (legJalan)   legJalan.style.display   = "none";
if (legPasar)   legPasar.style.display   = "none";

if (instruksiBox) instruksiBox.style.display = "none";


// ====== FUNGSI BANTU: update instruksi ======
function updateInstruksi() {
  if (!instruksiBox) return;

  // cek: ada minimal satu layer yang ON?
  var adaLayerInfo =
    cbKulprog.checked ||
    cbBekerja.checked ||
    cbUmkm.checked    ||
    cbJalan.checked   ||
    cbPasar.checked;

  if (!adaLayerInfo) {
    instruksiBox.style.display = "none";
    return;
  }

  // kalau ada layer ON → tampilkan instruksi
  // (kalau kamu punya flag instruksiDitutupManual, bisa tambahkan cek di sini)
  instruksiBox.style.display = "flex";
}

// ====== HANDLER CHECKBOX ======

// Aksesibilitas Terhadap Pasar (polygon)
cbKulprog.addEventListener("change", function () {
  if (this.checked) {
    map.addLayer(layer_kulprogkeckeckp_1);
    if (legKulprog) legKulprog.style.display = "block";
  } else {
    map.removeLayer(layer_kulprogkeckeckp_1);
    if (legKulprog) legKulprog.style.display = "none";
  }
  updateInstruksi();
});

// Rasio Penduduk Bekerja (ukuran lingkaran)
cbBekerja.addEventListener("change", function () {
  if (this.checked) {
    map.addLayer(layer_titikkkRasio_UMKM_2);
    if (legBekerja) legBekerja.style.display = "block";

    // kalau cuma Rasio Bekerja, pakai style abu-abu
    layer_titikkkRasio_UMKM_2.setStyle(function (feature) {
      return style_bekerjaOnly(feature);
    });
  } else {
    map.removeLayer(layer_titikkkRasio_UMKM_2);
    if (legBekerja) legBekerja.style.display = "none";

    // matikan juga UMKM
    cbUmkm.checked = false;
    if (legUmkm) legUmkm.style.display = "none";
  }
  updateInstruksi();
});

// Kepadatan Aktivitas UMKM (warna lingkaran)
cbUmkm.addEventListener("change", function () {
  if (this.checked) {
    // pastikan layer Rasio Bekerja ikut nyala
    if (!cbBekerja.checked) {
      cbBekerja.checked = true;
      map.addLayer(layer_titikkkRasio_UMKM_2);
      if (legBekerja) legBekerja.style.display = "block";
    }

    layer_titikkkRasio_UMKM_2.setStyle(function (feature) {
      return style_bekerjaUmkm(feature);
    });
    if (legUmkm) legUmkm.style.display = "block";
  } else {
    // balik ke mode Rasio Bekerja saja (abu-abu)
    layer_titikkkRasio_UMKM_2.setStyle(function (feature) {
      return style_bekerjaOnly(feature);
    });
    if (legUmkm) legUmkm.style.display = "none";
  }
  updateInstruksi();
});

// Jaringan Jalan
cbJalan.addEventListener("change", function () {
  if (this.checked) {
    map.addLayer(layer_jalanbnrjalann_3);
    if (legJalan) legJalan.style.display = "block";
  } else {
    map.removeLayer(layer_jalanbnrjalann_3);
    if (legJalan) legJalan.style.display = "none";
  }
  updateInstruksi();
});

// Pasar
cbPasar.addEventListener("change", function () {
  if (this.checked) {
    map.addLayer(layer_pasarunikpasarr_4);
    if (legPasar) legPasar.style.display = "block";
  } else {
    map.removeLayer(layer_pasarunikpasarr_4);
    if (legPasar) legPasar.style.display = "none";
  }
  updateInstruksi();
});
</script>
